<% layout('layout') %>

<!-- Language Toggle -->
<div class="position-fixed top-0 start-0 m-3" style="z-index: 1001;">
    <button class="btn btn-light btn-sm" onclick="toggleLanguage()">
        <i class="fas fa-globe me-1"></i>
        <span id="langText"><%= i18n.language === 'ar' ? 'EN' : 'عربي' %></span>
    </button>
</div>

<!-- Mobile Toggle -->
<button class="mobile-toggle" onclick="toggleSidebar()">
    <i class="fas fa-bars"></i>
</button>

<!-- Sidebar -->
<nav class="sidebar" id="sidebar">
    <div class="p-3">
        <div class="navbar-brand mb-4">
            <i class="fas fa-stethoscope me-2"></i>
            <span><%= t('app.name') %></span>
        </div>
        
        <!-- User Info -->
        <div class="text-center mb-4 p-3" style="background-color: rgba(255, 255, 255, 0.1); border-radius: 12px;">
            <div class="d-flex align-items-center">
                <div class="bg-white rounded-circle p-2 me-3">
                    <i class="fas fa-user-md text-primary"></i>
                </div>
                <div class="text-start">
                    <div class="fw-bold text-white"><%= user.username %></div>
                    <small class="text-white-50"><%= t('roles.' + user.role.toLowerCase()) %></small>
                </div>
            </div>
        </div>
        
        <!-- Navigation Menu -->
        <ul class="nav flex-column">
            <li class="nav-item">
                <a class="nav-link" href="/dashboard">
                    <i class="fas fa-tachometer-alt me-2"></i>
                    <span><%= t('nav.dashboard') %></span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/patients">
                    <i class="fas fa-users me-2"></i>
                    <span><%= t('nav.patients') %></span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/appointments">
                    <i class="fas fa-calendar-alt me-2"></i>
                    <span><%= t('nav.appointments') %></span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" href="/visits">
                    <i class="fas fa-notes-medical me-2"></i>
                    <span><%= t('nav.visits') %></span>
                </a>
            </li>
            <% if (user.role === 'ACCOUNTANT' || user.role === 'ADMIN') { %>
            <li class="nav-item">
                <a class="nav-link" href="/billing">
                    <i class="fas fa-file-invoice me-2"></i>
                    <span><%= t('nav.billing') %></span>
                </a>
            </li>
            <% } %>
            <% if (user.role === 'ADMIN') { %>
            <li class="nav-item">
                <a class="nav-link" href="/admin/services">
                    <i class="fas fa-cog me-2"></i>
                    <span><%= t('nav.services') %></span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/admin/users">
                    <i class="fas fa-users-cog me-2"></i>
                    <span><%= t('nav.users') %></span>
                </a>
            </li>
            <% } %>
            <li class="nav-item mt-3">
                <form action="/auth/logout" method="POST" class="d-inline">
                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                    <button type="submit" class="nav-link border-0 bg-transparent text-start w-100">
                        <i class="fas fa-sign-out-alt me-2"></i>
                        <span><%= t('nav.logout') %></span>
                    </button>
                </form>
            </li>
        </ul>
    </div>
</nav>

<!-- Main Content -->
<main class="main-content" id="mainContent">
    <!-- Header -->
    <div class="bg-white shadow-sm mb-4">
        <div class="container-fluid p-3">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h2 class="mb-0 fw-bold text-dark"><%= title %></h2>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-0">
                            <li class="breadcrumb-item"><a href="/visits"><%= t('nav.visits') %></a></li>
                            <li class="breadcrumb-item active"><%= isEdit ? t('visits.edit') : t('visits.add_new') %></li>
                        </ol>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="card">
                    <div class="card-body">
                        <form action="<%= isEdit ? `/visits/${visit.id}?_method=PUT` : '/visits' %>" method="POST">
                            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="patientId" class="form-label">
                                        <%= t('visits.patient') %> <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-select" id="patientId" name="patientId" required>
                                        <option value="">-- <%= t('actions.select') %> --</option>
                                        <% patients.forEach(patient => { %>
                                            <option value="<%= patient.id %>" 
                                                    <%= visit && visit.patientId === patient.id ? 'selected' : '' %>>
                                                <%= patient.name %> - <%= patient.civilId %>
                                            </option>
                                        <% }); %>
                                    </select>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="doctorId" class="form-label">
                                        <%= t('visits.doctor') %> <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-select" id="doctorId" name="doctorId" required>
                                        <option value="">-- <%= t('actions.select') %> --</option>
                                        <% doctors.forEach(doctor => { %>
                                            <option value="<%= doctor.id %>" 
                                                    <%= visit && visit.doctorId === doctor.id ? 'selected' : '' %>
                                                    <%= user.role === 'DOCTOR' && user.id === doctor.id ? 'selected' : '' %>>
                                                <%= doctor.username %>
                                            </option>
                                        <% }); %>
                                    </select>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="appointmentId" class="form-label">
                                        <%= t('visits.linked_appointment') %>
                                    </label>
                                    <select class="form-select" id="appointmentId" name="appointmentId">
                                        <option value="">-- <%= t('visits.no_appointment') %> --</option>
                                        <% appointments.forEach(appointment => { %>
                                            <option value="<%= appointment.id %>" 
                                                    <%= visit && visit.appointmentId === appointment.id ? 'selected' : '' %>>
                                                <%= appointment.patient.name %> - 
                                                <%= new Date(appointment.start).toLocaleDateString(i18n.language) %> 
                                                (<%= i18n.language === 'ar' ? appointment.service.nameAr : appointment.service.nameEn %>)
                                            </option>
                                        <% }); %>
                                    </select>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="diagnosis" class="form-label">
                                    <%= t('visits.diagnosis') %>
                                </label>
                                <textarea class="form-control" id="diagnosis" name="diagnosis" rows="3"
                                          placeholder="<%= t('visits.diagnosis_placeholder') %>"><%= visit ? (visit.diagnosis || '') : '' %></textarea>
                            </div>

                            <div class="mb-3">
                                <label for="notes" class="form-label">
                                    <%= t('visits.notes') %>
                                </label>
                                <textarea class="form-control" id="notes" name="notes" rows="4"
                                          placeholder="<%= t('visits.notes_placeholder') %>"><%= visit ? (visit.notes || '') : '' %></textarea>
                            </div>

                            <!-- Tooth Map Section -->
                            <div class="mb-4">
                                <label class="form-label">
                                    <i class="fas fa-tooth me-2"></i>
                                    <%= t('visits.tooth_map') %>
                                </label>
                                <div class="card">
                                    <div class="card-body">
                                        <p class="text-muted small"><%= t('visits.tooth_map_help') %></p>
                                        
                                        <!-- Adult Teeth Chart -->
                                        <div class="row">
                                            <!-- Upper Jaw -->
                                            <div class="col-12 mb-3">
                                                <h6 class="text-center text-muted"><%= t('visits.upper_jaw') %></h6>
                                                <div class="d-flex justify-content-center flex-wrap gap-1">
                                                    <% for (let i = 18; i >= 11; i--) { %>
                                                        <div class="tooth-button" data-tooth="<%= i %>" onclick="toggleTooth(this)">
                                                            <%= i %>
                                                        </div>
                                                    <% } %>
                                                    <div class="mx-2"></div>
                                                    <% for (let i = 21; i <= 28; i++) { %>
                                                        <div class="tooth-button" data-tooth="<%= i %>" onclick="toggleTooth(this)">
                                                            <%= i %>
                                                        </div>
                                                    <% } %>
                                                </div>
                                            </div>
                                            
                                            <!-- Lower Jaw -->
                                            <div class="col-12">
                                                <h6 class="text-center text-muted"><%= t('visits.lower_jaw') %></h6>
                                                <div class="d-flex justify-content-center flex-wrap gap-1">
                                                    <% for (let i = 48; i >= 41; i--) { %>
                                                        <div class="tooth-button" data-tooth="<%= i %>" onclick="toggleTooth(this)">
                                                            <%= i %>
                                                        </div>
                                                    <% } %>
                                                    <div class="mx-2"></div>
                                                    <% for (let i = 31; i <= 38; i++) { %>
                                                        <div class="tooth-button" data-tooth="<%= i %>" onclick="toggleTooth(this)">
                                                            <%= i %>
                                                        </div>
                                                    <% } %>
                                                </div>
                                            </div>
                                        </div>

                                        <input type="hidden" id="toothMapJson" name="toothMapJson" 
                                               value="<%= visit ? (visit.toothMapJson || '[]') : '[]' %>">
                                    </div>
                                </div>
                            </div>

                            <!-- Procedures Section -->
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fas fa-tools me-2"></i>
                                    <%= t('visits.procedures') %>
                                </label>
                                <div id="procedures-container">
                                    <div class="procedure-item">
                                        <div class="input-group mb-2">
                                            <input type="text" class="form-control" 
                                                   placeholder="<%= t('visits.procedure_description') %>" 
                                                   name="procedures[]">
                                            <button type="button" class="btn btn-outline-danger" onclick="removeProcedure(this)">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="addProcedure()">
                                    <i class="fas fa-plus me-1"></i>
                                    <%= t('visits.add_procedure') %>
                                </button>
                                <input type="hidden" id="proceduresJson" name="proceduresJson" 
                                       value="<%= visit ? (visit.proceduresJson || '[]') : '[]' %>">
                            </div>

                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-1"></i>
                                    <%= t('actions.save') %>
                                </button>
                                <a href="/visits" class="btn btn-outline-secondary">
                                    <i class="fas fa-times me-1"></i>
                                    <%= t('actions.cancel') %>
                                </a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<style>
.tooth-button {
    width: 35px;
    height: 35px;
    border: 2px solid #dee2e6;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 0.8rem;
    font-weight: 500;
    background: white;
    transition: all 0.2s;
}

.tooth-button:hover {
    border-color: var(--primary);
    background: rgba(31, 111, 214, 0.1);
}

.tooth-button.selected {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.procedure-item .input-group {
    max-width: 500px;
}
</style>

<script>
let selectedTeeth = [];
let procedures = [];

// Initialize from existing data
document.addEventListener('DOMContentLoaded', function() {
    // Load tooth map
    try {
        selectedTeeth = JSON.parse(document.getElementById('toothMapJson').value || '[]');
        selectedTeeth.forEach(tooth => {
            const button = document.querySelector(`[data-tooth="${tooth}"]`);
            if (button) button.classList.add('selected');
        });
    } catch (e) {
        selectedTeeth = [];
    }

    // Load procedures
    try {
        procedures = JSON.parse(document.getElementById('proceduresJson').value || '[]');
        const container = document.getElementById('procedures-container');
        container.innerHTML = '';
        if (procedures.length === 0) {
            addProcedure();
        } else {
            procedures.forEach(procedure => {
                addProcedure(procedure);
            });
        }
    } catch (e) {
        procedures = [];
    }
});

function toggleTooth(button) {
    const tooth = parseInt(button.dataset.tooth);
    const index = selectedTeeth.indexOf(tooth);
    
    if (index === -1) {
        selectedTeeth.push(tooth);
        button.classList.add('selected');
    } else {
        selectedTeeth.splice(index, 1);
        button.classList.remove('selected');
    }
    
    document.getElementById('toothMapJson').value = JSON.stringify(selectedTeeth);
}

function addProcedure(value = '') {
    const container = document.getElementById('procedures-container');
    const div = document.createElement('div');
    div.className = 'procedure-item';
    div.innerHTML = `
        <div class="input-group mb-2">
            <input type="text" class="form-control procedure-input" 
                   placeholder="<%= t('visits.procedure_description') %>" 
                   value="${value}">
            <button type="button" class="btn btn-outline-danger" onclick="removeProcedure(this)">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;
    container.appendChild(div);
    updateProceduresJson();
}

function removeProcedure(button) {
    button.closest('.procedure-item').remove();
    updateProceduresJson();
}

function updateProceduresJson() {
    const inputs = document.querySelectorAll('.procedure-input');
    procedures = Array.from(inputs)
        .map(input => input.value.trim())
        .filter(value => value !== '');
    document.getElementById('proceduresJson').value = JSON.stringify(procedures);
}

// Update procedures JSON when inputs change
document.addEventListener('input', function(e) {
    if (e.target.classList.contains('procedure-input')) {
        updateProceduresJson();
    }
});
</script>
